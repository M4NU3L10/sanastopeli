<!doctype html>
<html lang="fi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sanastopeli</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸŒ</text></svg>">
<link rel="apple-touch-icon" href="icon.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Sanastopeli">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0f0a2e">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESET & ROOT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --font: 'Outfit', sans-serif;
  --rx: 28px; --rl: 18px; --rm: 12px;
  --glass: rgba(255,255,255,0.08);
  --glass-h: rgba(255,255,255,0.14);
  --border: rgba(255,255,255,0.15);
  --blur: blur(24px) saturate(180%);
  --tp: rgba(255,255,255,0.95);
  --ts: rgba(255,255,255,0.60);
  --pink: #ff6ec7; --blue: #6eb8ff; --purple: #b06eff;
  --green: #4ade80; --yellow: #fbbf24; --red: #f87171;
}
html { height: 100%; }
body {
  font-family: var(--font); color: var(--tp); overflow-x: hidden;
  min-height: 100vh; display: flex; flex-direction: column; align-items: center;
  padding: 16px 16px 116px;
  background: linear-gradient(135deg,#1a1a2e,#16213e,#0f3460,#533483);
  background-attachment: fixed; transition: background 0.9s ease;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOADER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

#appLoader {
  position: fixed;
  inset: 0;
  z-index: 9999;
  background: linear-gradient(135deg,#1a1a2e,#16213e,#0f3460,#533483);
  display: flex;
  align-items: center;
  justify-content: center;
  transition: opacity 0.6s ease, visibility 0.6s ease;
}

#appLoader.hide {
  opacity: 0;
  visibility: hidden;
}

.loader-inner {
  text-align: center;
  position: relative;
  animation: fadeUp 0.6s ease;
}

.loader-glow {
  position: absolute;
  width: 180px;
  height: 180px;
  background: radial-gradient(circle, rgba(176,110,255,0.4), transparent 70%);
  border-radius: 50%;
  filter: blur(40px);
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  animation: pulse 2.5s ease-in-out infinite;
}

.loader-logo {
  font-size: 64px;
  margin-bottom: 16px;
  animation: float 3s ease-in-out infinite;
}

.loader-title {
  font-size: 22px;
  font-weight: 700;
  margin-bottom: 26px;
  letter-spacing: 0.05em;
  background: linear-gradient(135deg,var(--pink),var(--blue));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.loader-bar {
  width: 200px;
  height: 6px;
  background: rgba(255,255,255,0.15);
  border-radius: 100px;
  overflow: hidden;
  margin: 0 auto;
}

.loader-bar-fill {
  height: 100%;
  width: 0%;
  border-radius: 100px;
  background: linear-gradient(90deg,var(--blue),var(--purple),var(--pink));
  transition: width 0.4s ease;
}

@keyframes float {
  0% { transform: translateY(0); }
  50% { transform: translateY(-8px); }
  100% { transform: translateY(0); }
}

@keyframes pulse {
  0% { opacity: 0.5; transform: translate(-50%, -50%) scale(1); }
  100% { opacity: 0.8; transform: translate(-50%, -50%) scale(1.2); }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BACKGROUND ORBS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.bg-orbs { position: fixed; inset: 0; pointer-events: none; z-index: 0; overflow: hidden; }
.orb { position: absolute; border-radius: 50%; filter: blur(80px); opacity: 0.22; animation: drift 20s ease-in-out infinite alternate; }
.orb-1 { width: 520px; height: 520px; top: -140px; left: -120px; background: radial-gradient(circle,#a855f7,transparent 70%); }
.orb-2 { width: 420px; height: 420px; bottom: -80px; right: -100px; background: radial-gradient(circle,#ec4899,transparent 70%); animation-duration: 26s; animation-delay: -9s; }
.orb-3 { width: 320px; height: 320px; top: 42%; left: 52%; background: radial-gradient(circle,#60a5fa,transparent 70%); animation-duration: 23s; animation-delay: -5s; }
@keyframes drift { from { transform: translate(0,0) scale(1); } to { transform: translate(45px,55px) scale(1.12); } }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   APP WRAPPER & GLASS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.app { position: relative; z-index: 1; width: 100%; max-width: 560px; padding-top: 68px; }
.glass {
  background: var(--glass); border: 1px solid var(--border);
  backdrop-filter: var(--blur); -webkit-backdrop-filter: var(--blur);
  border-radius: var(--rx);
  box-shadow: 0 8px 40px rgba(0,0,0,0.35), inset 0 1px 0 rgba(255,255,255,0.14);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SETTINGS BUTTON
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#settingsBtn {
  position: fixed; top: 14px; left: 14px; z-index: 400;
  width: 46px; height: 46px; border-radius: 50%;
  background: var(--glass); border: 1px solid var(--border);
  backdrop-filter: var(--blur); -webkit-backdrop-filter: var(--blur);
  display: flex; align-items: center; justify-content: center;
  font-size: 21px; cursor: pointer;
  box-shadow: 0 4px 20px rgba(0,0,0,0.3);
  transition: background 0.2s, transform 0.3s ease; color: var(--tp);
}
#settingsBtn:hover { background: var(--glass-h); transform: scale(1.08) rotate(25deg); }
#settingsBtn.open  { transform: scale(1.08) rotate(60deg); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SETTINGS PANEL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#settingsPanel {
  position: fixed; top: 70px; left: 14px; z-index: 400; width: 270px;
  background: rgba(15,8,35,0.7); border: 1px solid var(--border);
  backdrop-filter: blur(40px) saturate(220%); -webkit-backdrop-filter: blur(40px) saturate(220%);
  border-radius: var(--rl); padding: 18px 16px;
  box-shadow: 0 16px 60px rgba(0,0,0,0.55), inset 0 1px 0 rgba(255,255,255,0.1);
  transform-origin: top left; transform: scale(0.82) translateY(-6px);
  opacity: 0; pointer-events: none;
  transition: transform 0.28s cubic-bezier(0.34,1.56,0.64,1), opacity 0.22s ease;
}
#settingsPanel.open { transform: scale(1) translateY(0); opacity: 1; pointer-events: all; }
.set-label {
  font-size: 10.5px; font-weight: 700; letter-spacing: 0.1em;
  text-transform: uppercase; color: var(--ts); margin-bottom: 10px;
}
.set-section { margin-top: 16px; }
.swatches { display: flex; gap: 8px; flex-wrap: wrap; }
.swatch {
  width: 38px; height: 38px; border-radius: 50%;
  border: 2.5px solid transparent; cursor: pointer;
  box-shadow: 0 2px 10px rgba(0,0,0,0.45);
  transition: transform 0.2s, border-color 0.2s; flex-shrink: 0;
}
.swatch:hover { transform: scale(1.18); }
.swatch.active { border-color: rgba(255,255,255,0.9); transform: scale(1.18); }
.dir-row {
  display: flex; align-items: center; gap: 10px;
  background: rgba(255,255,255,0.07); border: 1px solid var(--border);
  border-radius: var(--rm); padding: 11px 12px;
  cursor: pointer; transition: background 0.2s; user-select: none;
}
.dir-row:hover { background: rgba(255,255,255,0.13); }
.dir-row .dr-flags { font-size: 17px; white-space: nowrap; }
.dir-row .dr-text  { font-size: 13px; font-weight: 600; flex: 1; line-height: 1.2; }
.dir-dot {
  width: 20px; height: 20px; border-radius: 50%;
  border: 2px solid var(--pink); display: flex; align-items: center;
  justify-content: center; font-size: 11px; color: var(--pink);
  transition: background 0.2s; flex-shrink: 0;
}
.dir-row.reversed .dir-dot { background: var(--pink); color: #fff; }
.btn-quit {
  width: 100%; margin-top: 14px; padding: 10px 14px;
  border-radius: var(--rm); border: 1px solid rgba(248,113,113,0.35);
  background: rgba(248,113,113,0.12); color: var(--red);
  font-family: var(--font); font-size: 13px; font-weight: 700;
  cursor: pointer; transition: background 0.2s; display: none;
}
.btn-quit:hover { background: rgba(248,113,113,0.22); }
.btn-quit.vis { display: block; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOTTOM NAV  (4 buttons)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#bottomNav {
  position: fixed; bottom: 18px; left: 50%; transform: translateX(-50%); z-index: 400;
  display: flex;
  background: rgba(15,8,35,0.65); border: 1px solid var(--border);
  backdrop-filter: blur(40px) saturate(220%); -webkit-backdrop-filter: blur(40px) saturate(220%);
  border-radius: 100px; padding: 5px;
  box-shadow: 0 8px 40px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.1);
}
.nb {
  display: flex; flex-direction: column; align-items: center; gap: 2px;
  padding: 8px 16px; border-radius: 100px; border: none;
  background: transparent; color: var(--ts);
  font-family: var(--font); font-size: 10.5px; font-weight: 600;
  cursor: pointer; transition: background 0.2s, color 0.2s;
  white-space: nowrap; user-select: none;
}
.nb .ni { font-size: 20px; line-height: 1; }
.nb.active { background: rgba(255,255,255,0.15); color: var(--tp); box-shadow: inset 0 1px 0 rgba(255,255,255,0.15); }
.nb:hover:not(.active) { background: rgba(255,255,255,0.07); color: rgba(255,255,255,0.8); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   OVERLAY & SCREENS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#overlay { display: none; position: fixed; inset: 0; z-index: 300; }
#overlay.open { display: block; }
.screen { display: none; }
.screen.active { display: block; animation: fadeUp 0.32s ease; }
@keyframes fadeUp { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   START SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.start-inner { padding: 52px 36px; text-align: center; }
.start-h1 { font-size: clamp(24px,6vw,36px); font-weight: 800; line-height: 1.15; margin-bottom: 10px; }
.start-h1 span { background: linear-gradient(130deg,var(--pink),var(--blue)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
.lang-pill {
  display: inline-flex; align-items: center; gap: 6px;
  background: rgba(255,255,255,0.1); border: 1px solid var(--border);
  border-radius: 100px; padding: 5px 16px; font-size: 14px; font-weight: 600; margin-bottom: 22px;
}
.start-desc { color: var(--ts); font-size: 15px; line-height: 1.6; margin-bottom: 34px; }
.btn-go {
  display: inline-flex; align-items: center; gap: 8px;
  background: linear-gradient(135deg,var(--pink),var(--purple)); color: #fff;
  font-family: var(--font); font-weight: 700; font-size: 18px;
  padding: 16px 44px; border-radius: 100px; border: none; cursor: pointer;
  box-shadow: 0 4px 30px rgba(255,110,199,0.42);
  transition: transform 0.18s, box-shadow 0.18s;
}
.btn-go:hover  { transform: translateY(-2px) scale(1.03); box-shadow: 0 8px 40px rgba(255,110,199,0.55); }
.btn-go:active { transform: scale(0.97); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SHARED GAME ELEMENTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.prog-row { display: flex; justify-content: space-between; font-size: 13px; color: var(--ts); font-weight: 600; margin-bottom: 5px; }
.prog-track { height: 5px; background: rgba(255,255,255,0.12); border-radius: 100px; margin-bottom: 20px; overflow: hidden; }
.prog-fill { height: 100%; border-radius: 100px; background: linear-gradient(90deg,var(--blue),var(--purple),var(--pink)); transition: width 0.55s cubic-bezier(.4,0,.2,1); }
.dir-hint { text-align: center; font-size: 11px; font-weight: 700; letter-spacing: 0.07em; text-transform: uppercase; color: var(--ts); margin-bottom: 10px; }
.word-card {
  background: rgba(255,255,255,0.10); border: 1px solid rgba(255,255,255,0.18);
  border-radius: var(--rl); padding: 28px 20px; text-align: center; margin-bottom: 18px;
  box-shadow: inset 0 1px 0 rgba(255,255,255,0.1);
}
.word-text { font-size: clamp(18px,5vw,28px); font-weight: 700; line-height: 1.35; }
.fb {
  border-radius: var(--rm); padding: 13px 16px; text-align: center;
  font-weight: 600; font-size: 14.5px; margin-bottom: 12px; line-height: 1.4; display: none;
}
.fb.show { display: block; animation: pop 0.22s cubic-bezier(0.34,1.56,0.64,1); }
@keyframes pop { from { transform: scale(0.88); opacity: 0; } to { transform: scale(1); opacity: 1; } }
.fb.ok   { background: rgba(74,222,128,0.14); border: 1px solid rgba(74,222,128,0.4); color: var(--green); }
.fb.warn { background: rgba(251,191,36,0.14); border: 1px solid rgba(251,191,36,0.4); color: var(--yellow); }
.fb.err  { background: rgba(248,113,113,0.14); border: 1px solid rgba(248,113,113,0.4); color: var(--red); }
.btn-check {
  width: 100%; padding: 14px; border: none; border-radius: var(--rm);
  font-family: var(--font); font-size: 16px; font-weight: 700; cursor: pointer;
  background: linear-gradient(135deg,var(--pink),var(--purple)); color: #fff;
  box-shadow: 0 4px 20px rgba(255,110,199,0.3);
  transition: transform 0.14s, box-shadow 0.14s;
}
.btn-check:hover { transform: translateY(-1px); box-shadow: 0 6px 28px rgba(255,110,199,0.48); }
.btn-check:active { transform: scale(0.98); }
.btn-next {
  width: 100%; padding: 14px; border-radius: var(--rm); cursor: pointer;
  font-family: var(--font); font-size: 16px; font-weight: 700;
  background: rgba(110,184,255,0.16); border: 1px solid rgba(110,184,255,0.32);
  color: var(--blue); transition: background 0.15s; display: none;
}
.btn-next:hover { background: rgba(110,184,255,0.26); }
.btn-next.vis { display: block; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   WRITE MODE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.game-inner { padding: 26px 26px 22px; }
#answerInput {
  width: 100%; background: rgba(255,255,255,0.09);
  border: 1.5px solid rgba(255,255,255,0.2); border-radius: var(--rm);
  padding: 14px 18px; font-family: var(--font); font-size: 17px; font-weight: 500;
  color: var(--tp); outline: none; transition: border-color 0.2s, background 0.2s; margin-bottom: 12px;
}
#answerInput::placeholder { color: rgba(255,255,255,0.32); }
#answerInput:focus { border-color: rgba(255,110,199,0.65); background: rgba(255,255,255,0.13); }
#answerInput:disabled { opacity: 0.65; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MULTIPLE CHOICE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.choices { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px; }
.choice {
  background: rgba(255,255,255,0.08); border: 1.5px solid rgba(255,255,255,0.14);
  border-radius: var(--rm); padding: 14px 10px;
  font-family: var(--font); font-size: 14.5px; font-weight: 600;
  color: var(--tp); cursor: pointer; text-align: center; line-height: 1.3;
  min-height: 58px; display: flex; align-items: center; justify-content: center;
  transition: background 0.15s, border-color 0.15s, transform 0.12s;
}
.choice:hover:not(:disabled) { background: rgba(255,255,255,0.16); border-color: rgba(255,255,255,0.3); transform: scale(1.03); }
.choice:active:not(:disabled) { transform: scale(0.97); }
.choice:disabled { cursor: default; }
.choice.correct { background: rgba(74,222,128,0.18); border-color: var(--green); color: var(--green); }
.choice.wrong   { background: rgba(248,113,113,0.18); border-color: var(--red);   color: var(--red); }
.choice.dim     { opacity: 0.38; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FLASHCARD MODE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.flash-inner { padding: 26px 26px 22px; }

.card-scene {
  perspective: 900px; width: 100%; margin-bottom: 14px; cursor: pointer;
}
.card-3d {
  width: 100%; height: 190px; position: relative;
  transform-style: preserve-3d;
  transition: transform 0.55s cubic-bezier(0.4,0,0.2,1);
}
.card-3d.flipped { transform: rotateY(180deg); }
.card-face {
  position: absolute; inset: 0; backface-visibility: hidden;
  -webkit-backface-visibility: hidden; border-radius: var(--rl);
  display: flex; flex-direction: column; align-items: center;
  justify-content: center; padding: 24px 20px; text-align: center;
  user-select: none;
}
.card-front {
  background: rgba(255,255,255,0.10); border: 1px solid rgba(255,255,255,0.20);
  box-shadow: inset 0 1px 0 rgba(255,255,255,0.12);
}
.card-back {
  transform: rotateY(180deg);
  background: rgba(110,184,255,0.10); border: 1px solid rgba(110,184,255,0.30);
  box-shadow: inset 0 1px 0 rgba(110,184,255,0.15);
}
.card-side-label {
  font-size: 10px; font-weight: 700; letter-spacing: 0.1em;
  text-transform: uppercase; color: var(--ts); margin-bottom: 10px;
}
.card-word { font-size: clamp(18px,5vw,28px); font-weight: 700; line-height: 1.35; }
.card-tap-hint {
  font-size: 12px; color: var(--ts); text-align: center; margin-bottom: 14px;
  min-height: 18px; transition: opacity 0.3s;
}
.card-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px; display: none; }
.card-actions.vis { display: grid; }
.btn-card-wrong {
  padding: 14px; border-radius: var(--rm);
  border: 1px solid rgba(248,113,113,0.4); background: rgba(248,113,113,0.12);
  color: var(--red); font-family: var(--font); font-size: 15px; font-weight: 700;
  cursor: pointer; transition: background 0.15s, transform 0.12s;
}
.btn-card-wrong:hover { background: rgba(248,113,113,0.22); transform: scale(1.02); }
.btn-card-right {
  padding: 14px; border-radius: var(--rm);
  border: 1px solid rgba(74,222,128,0.4); background: rgba(74,222,128,0.12);
  color: var(--green); font-family: var(--font); font-size: 15px; font-weight: 700;
  cursor: pointer; transition: background 0.15s, transform 0.12s;
}
.btn-card-right:hover { background: rgba(74,222,128,0.22); transform: scale(1.02); }
.card-key-hints {
  display: none; justify-content: center; gap: 18px;
  font-size: 12px; color: var(--ts); text-align: center; margin-bottom: 0;
}
.card-key-hints.vis { display: flex; }
.key-hint { display: flex; align-items: center; gap: 5px; }
.key-badge {
  background: rgba(255,255,255,0.12); border: 1px solid var(--border);
  border-radius: 5px; padding: 2px 6px; font-size: 11px; font-weight: 700;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   WORD BUILDER MODE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.build-inner { padding: 26px 26px 22px; }
.build-question { margin-bottom: 16px; }

.build-answer-wrap {
  display: flex; align-items: flex-start; gap: 8px; margin-bottom: 14px; flex-wrap: wrap;
}
.build-article {
  background: rgba(176,110,255,0.18); border: 1px solid rgba(176,110,255,0.4);
  color: var(--purple); border-radius: 10px; padding: 8px 12px;
  font-size: 16px; font-weight: 700; white-space: nowrap; flex-shrink: 0;
  align-self: center;
}
.build-slots { display: flex; flex-wrap: wrap; gap: 5px; flex: 1; }
.build-slot {
  width: 36px; height: 44px; border-radius: 9px;
  display: flex; align-items: center; justify-content: center;
  font-size: 17px; font-weight: 700; transition: background 0.15s, transform 0.12s;
}
.build-slot.empty {
  background: rgba(255,255,255,0.06); border: 1.5px dashed rgba(255,255,255,0.2);
}
.build-slot.filled {
  background: rgba(110,184,255,0.15); border: 1.5px solid rgba(110,184,255,0.4);
  color: var(--blue); cursor: pointer;
}
.build-slot.filled:hover { background: rgba(248,113,113,0.15); border-color: rgba(248,113,113,0.5); color: var(--red); }
.build-slot.correct-slot { background: rgba(74,222,128,0.18); border-color: var(--green); color: var(--green); }
.build-slot.wrong-slot   { background: rgba(248,113,113,0.18); border-color: var(--red);   color: var(--red); }

.build-tiles-wrap {
  display: flex; flex-wrap: wrap; gap: 7px; padding: 12px;
  background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08);
  border-radius: var(--rm); margin-bottom: 14px; min-height: 68px;
}
.build-tile {
  width: 36px; height: 44px; border-radius: 9px;
  background: rgba(255,255,255,0.12); border: 1.5px solid rgba(255,255,255,0.2);
  display: flex; align-items: center; justify-content: center;
  font-size: 17px; font-weight: 700; cursor: pointer; user-select: none;
  transition: background 0.15s, transform 0.12s, opacity 0.2s;
}
.build-tile:hover { background: rgba(255,255,255,0.22); transform: translateY(-3px); }
.build-tile:active { transform: scale(0.93); }
.build-tile.used { opacity: 0.18; pointer-events: none; }

.build-controls { display: flex; gap: 8px; margin-bottom: 12px; }
.btn-build-clear {
  flex: 0 0 auto; padding: 10px 16px; border-radius: var(--rm);
  border: 1px solid var(--border); background: rgba(255,255,255,0.07);
  color: var(--ts); font-family: var(--font); font-size: 14px; font-weight: 600;
  cursor: pointer; transition: background 0.15s;
}
.btn-build-clear:hover { background: rgba(255,255,255,0.13); }
.build-len-hint { font-size: 12px; color: var(--ts); align-self: center; }

/* Skip-word (for non-buildable in build mode) */
.skip-notice {
  background: rgba(251,191,36,0.1); border: 1px solid rgba(251,191,36,0.3);
  border-radius: var(--rm); padding: 10px 14px; color: var(--yellow);
  font-size: 13px; font-weight: 600; text-align: center; margin-bottom: 12px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESULTS SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.results-inner { padding: 52px 32px; text-align: center; }
.res-emoji { font-size: 70px; margin-bottom: 14px; display: block; animation: bounceIn 0.5s cubic-bezier(0.34,1.56,0.64,1); }
@keyframes bounceIn { from { transform: scale(0.25); opacity: 0; } to { transform: scale(1); opacity: 1; } }
.res-title { font-size: 27px; font-weight: 800; margin-bottom: 18px; }
.res-score { font-size: 56px; font-weight: 800; background: linear-gradient(135deg,var(--green),var(--blue)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
.res-pct  { font-size: 21px; color: var(--ts); margin-bottom: 6px; }
.res-msg  { font-size: 16px; color: var(--ts); margin-bottom: 30px; }
.res-btns { display: flex; flex-direction: column; gap: 10px; }
.btn-res {
  padding: 13px 24px; border-radius: 100px;
  font-family: var(--font); font-size: 15px; font-weight: 700;
  cursor: pointer; transition: transform 0.15s, box-shadow 0.15s; border: none;
}
.btn-res.prim { background: linear-gradient(135deg,var(--pink),var(--purple)); color: #fff; box-shadow: 0 4px 20px rgba(255,110,199,0.3); }
.btn-res.prim:hover { transform: translateY(-2px); box-shadow: 0 6px 28px rgba(255,110,199,0.48); }
.btn-res.sec { background: rgba(255,255,255,0.09); border: 1px solid var(--border); color: var(--tp); }
.btn-res.sec:hover { background: rgba(255,255,255,0.15); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   iOS HINT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#iosHint {
  display: none; position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%);
  background: rgba(15,10,46,0.92); backdrop-filter: blur(20px);
  border: 1px solid var(--border); color: white; font-size: 13px;
  padding: 12px 16px; border-radius: 14px; z-index: 500; width: 290px;
  text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.4);
}
#iosHint button {
  background: none; border: none; color: rgba(255,255,255,0.6);
  font-size: 16px; cursor: pointer; margin-left: 8px; vertical-align: middle;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UTILITIES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.hidden { display: none !important; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESPONSIVE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media (max-width: 440px) {
  body { padding: 12px 12px 114px; }
  .game-inner, .flash-inner, .build-inner { padding: 20px 16px 18px; }
  .choices { grid-template-columns: 1fr; }
  .nb { padding: 8px 10px; font-size: 9.5px; }
  .nb .ni { font-size: 18px; }
  .build-slot, .build-tile { width: 32px; height: 40px; font-size: 15px; }
}
</style>
</head>
<body>

<!-- LOADING SCREEN -->
<div id="appLoader">
  <div class="loader-inner">
    <div class="loader-glow"></div>
    <div class="loader-logo">ğŸŒ</div>
    <div class="loader-title">Sanastopeli</div>
    <div class="loader-bar">
      <div class="loader-bar-fill" id="loaderBarFill"></div>
    </div>
  </div>
</div>
   
<div class="bg-orbs" aria-hidden="true">
  <div class="orb orb-1"></div><div class="orb orb-2"></div><div class="orb orb-3"></div>
</div>

<!-- Settings button -->
<button id="settingsBtn" aria-label="Asetukset" aria-expanded="false">âš™ï¸</button>
<div id="overlay"></div>

<!-- Settings panel -->
<div id="settingsPanel" role="dialog" aria-label="Asetukset">
  <div class="set-label">TaustavÃ¤ri</div>
  <div class="swatches" id="swatchWrap"></div>

  <div id="dirSection">
    <div class="set-label set-section">KÃ¤Ã¤nnÃ¶ssuunta</div>
    <div class="dir-row" id="dirRow" role="button" tabindex="0" aria-label="Vaihda kÃ¤Ã¤nnÃ¶ssuunta">
      <span class="dr-flags" id="drFlags"></span>
      <span class="dr-text"  id="drText"></span>
      <span class="dir-dot"  id="dirDot">â†”</span>
    </div>
  </div>

  <button class="btn-quit" id="btnQuit">âœ• Lopeta peli</button>
</div>

<!-- â•â•â• APP â•â•â• -->
<main class="app">

  <!-- START -->
  <section class="screen active glass" id="startScreen">
    <div class="start-inner">
      <h1 class="start-h1"><span id="startH1"></span></h1>
      <div class="lang-pill" id="langPill"></div>
      <p class="start-desc" id="startDesc"></p>
      <button class="btn-go" id="btnGo">Aloita ğŸš€</button>
    </div>
  </section>

  <!-- WRITE / MULTIPLE CHOICE -->
  <section class="screen glass" id="gameScreen">
    <div class="game-inner">
      <div class="prog-row"><span id="progTxt"></span><span id="scoreTxt"></span></div>
      <div class="prog-track"><div class="prog-fill" id="progFill" style="width:0%"></div></div>
      <div class="dir-hint" id="dirHint"></div>
      <div class="word-card"><div class="word-text" id="wordTxt"></div></div>
      <div id="writeWrap">
        <input id="answerInput" type="text" autocomplete="off" autocorrect="off"
               autocapitalize="off" spellcheck="false" placeholder="Kirjoita vastausâ€¦">
      </div>
      <div id="choiceWrap" class="hidden">
        <div class="choices" id="choicesGrid"></div>
      </div>
      <div class="fb" id="fb"></div>
      <button class="btn-check" id="btnCheck">Tarkista âœ“</button>
      <button class="btn-next"  id="btnNext">Seuraava â¡</button>
    </div>
  </section>

  <!-- FLASHCARD -->
  <section class="screen glass" id="flashScreen">
    <div class="flash-inner">
      <div class="prog-row"><span id="fProgTxt"></span><span id="fScoreTxt"></span></div>
      <div class="prog-track"><div class="prog-fill" id="fProgFill" style="width:0%"></div></div>
      <div class="dir-hint" id="fDirHint"></div>

      <div class="card-scene" id="cardScene" role="button" tabindex="0" aria-label="KÃ¤Ã¤nnÃ¤ kortti">
        <div class="card-3d" id="card3d">
          <div class="card-face card-front">
            <div class="card-side-label" id="cardFrontLabel"></div>
            <div class="card-word" id="cardFront"></div>
          </div>
          <div class="card-face card-back">
            <div class="card-side-label" id="cardBackLabel"></div>
            <div class="card-word" id="cardBack"></div>
          </div>
        </div>
      </div>

      <div class="card-tap-hint" id="cardTapHint">Napauta korttia kÃ¤Ã¤ntÃ¤Ã¤ksesi â†•</div>

      <div class="card-actions" id="cardActions">
        <button class="btn-card-wrong" id="btnCardWrong">âœ— &nbsp;VÃ¤Ã¤rin</button>
        <button class="btn-card-right" id="btnCardRight">âœ“ &nbsp;Oikein</button>
      </div>

      <div class="card-key-hints" id="cardKeyHints">
        <span class="key-hint"><span class="key-badge">â†</span> VÃ¤Ã¤rin</span>
        <span class="key-hint"><span class="key-badge">â†‘â†“</span> KÃ¤Ã¤nnÃ¤</span>
        <span class="key-hint"><span class="key-badge">â†’</span> Oikein</span>
      </div>
    </div>
  </section>

  <!-- WORD BUILDER -->
  <section class="screen glass" id="buildScreen">
    <div class="build-inner">
      <div class="prog-row"><span id="bProgTxt"></span><span id="bScoreTxt"></span></div>
      <div class="prog-track"><div class="prog-fill" id="bProgFill" style="width:0%"></div></div>
      <div class="dir-hint" id="bDirHint"></div>

      <div class="word-card build-question">
        <div class="word-text" id="buildQuestion"></div>
      </div>

      <div class="build-answer-wrap">
        <span class="build-article" id="buildArticle" style="display:none"></span>
        <div class="build-slots" id="buildSlots"></div>
      </div>

      <div class="build-tiles-wrap" id="buildTiles"></div>

      <div class="build-controls">
        <button class="btn-build-clear" id="btnBuildClear">âŒ« TyhjennÃ¤</button>
        <span class="build-len-hint" id="buildLenHint"></span>
      </div>

      <div class="fb" id="bFb"></div>
      <button class="btn-check" id="btnBuildCheck">Tarkista âœ“</button>
      <button class="btn-next"  id="btnBuildNext">Seuraava â¡</button>
    </div>
  </section>

  <!-- RESULTS -->
  <section class="screen glass" id="resultsScreen">
    <div class="results-inner">
      <span class="res-emoji" id="resEmoji"></span>
      <h2 class="res-title">Peli pÃ¤Ã¤ttyi!</h2>
      <div class="res-score" id="resScore"></div>
      <div class="res-pct"   id="resPct"></div>
      <div class="res-msg"   id="resMsg"></div>
      <div class="res-btns">
        <button class="btn-res prim" id="btnRestart">Pelaa uudelleen ğŸ”„</button>
        <button class="btn-res sec hidden" id="btnWrong"></button>
      </div>
    </div>
  </section>

</main>

<!-- Bottom nav â€” 4 modes -->
<nav id="bottomNav" aria-label="Pelimuoto">
  <button class="nb" data-mode="flash"    id="nbFlash">   <span class="ni">ğŸª§</span>KÃ¤Ã¤ntÃ¶kortit</button>
  <button class="nb" data-mode="build"    id="nbBuild">   <span class="ni">ğŸ—ï¸</span>Rakenna   </button>
  <button class="nb" data-mode="multiple" id="nbMultiple"><span class="ni">ğŸ”¡</span>Monivalinta</button>
  <button class="nb active" data-mode="write" id="nbWrite"><span class="ni">âœï¸</span>Kirjoitus</button>
</nav>

<!-- iOS hint -->
<div id="iosHint">
  LisÃ¤Ã¤ kotinÃ¤ytÃ¶lle: paina <strong>â‹ Jaa</strong> â†’ <strong>LisÃ¤Ã¤ Koti-valikkoon</strong>
  <button onclick="this.parentElement.style.display='none'">âœ•</button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     VOCABULARY â€” muokkaa tÃ¤tÃ¤ osioita
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
const LANG = {
  sourceLanguage:  'Suomi',   targetLanguage:  'Saksa',
  sourceFlagEmoji: 'ğŸ‡«ğŸ‡®',    targetFlagEmoji: 'ğŸ‡©ğŸ‡ª',
};

const VOCAB = [
  { source:"Palkinto kahdelle",                         target:"Gewinn fÃ¼r zwei",                             article:null,  word:"Gewinn fÃ¼r zwei" },
  { source:"voitto, palkinto",                          target:"der Gewinn",                                  article:"der", word:"Gewinn" },
  { source:"Karoline voitti ensimmÃ¤isen palkinnon.",    target:"Karoline hat den ersten Preis gewonnen.",     article:null,  word:"Karoline hat den ersten Preis gewonnen." },
  { source:"palkinto; hinta",                           target:"der Preis",                                   article:"der", word:"Preis" },
  { source:"kilpailu",                                  target:"der Wettbewerb",                              article:"der", word:"Wettbewerb" },
  { source:"voittaa",                                   target:"gewinnen",                                    article:null,  word:"gewinnen" },
  { source:"HÃ¤n soittaa (poika) ystÃ¤vÃ¤lleen Erikille.", target:"Sie ruft ihren Freund Erik an.",              article:null,  word:"Sie ruft ihren Freund Erik an." },
  { source:"soittaa puhelimella",                       target:"anrufen",                                     article:null,  word:"anrufen" },
  { source:"kulta, aarre",                              target:"der Schatz",                                  article:"der", word:"Schatz" },
  { source:"jotain tosi mieletÃ¶ntÃ¤",                    target:"etwas total Krasses",                         article:null,  word:"etwas total Krasses" },
  { source:"mieletÃ¶n, huikea, upea",                    target:"krass",                                       article:null,  word:"krass" },
  { source:"kertoa",                                    target:"erzÃ¤hlen",                                    article:null,  word:"erzÃ¤hlen" },
  { source:"tietÃ¤Ã¤",                                    target:"wissen",                                      article:null,  word:"wissen" },
  { source:"tosi siistiÃ¤",                              target:"megageil",                                    article:null,  word:"megageil" },
  { source:"MinÃ¤ iloitsen puolestasi!",                 target:"Ich freue mich fÃ¼r dich!",                   article:null,  word:"Ich freue mich fÃ¼r dich!" },
  { source:"iloita",                                    target:"sich freuen",                                 article:null,  word:"sich freuen" },
  { source:"Olet todella ansainnut sen!",               target:"Du hast es echt verdient!",                  article:null,  word:"Du hast es echt verdient!" },
  { source:"aito; tÃ¤ssÃ¤: todella",                      target:"echt",                                        article:null,  word:"echt" },
  { source:"ansaita",                                   target:"verdienen",                                   article:null,  word:"verdienen" },
  { source:"vielÃ¤",                                     target:"noch",                                        article:null,  word:"noch" },
  { source:"matka",                                     target:"die Reise",                                   article:"die", word:"Reise" },
  { source:"ItÃ¤valtaan",                                target:"nach Ã–sterreich",                             article:null,  word:"nach Ã–sterreich" },
  { source:"Donauinselfest-festareille",                target:"zum Donauinselfest",                          article:null,  word:"zum Donauinselfest" },
  { source:"Tonava",                                    target:"die Donau",                                   article:"die", word:"Donau" },
  { source:"saari",                                     target:"die Insel",                                   article:"die", word:"Insel" },
  { source:"juhla",                                     target:"das Fest",                                    article:"das", word:"Fest" },
  { source:"sisÃ¤ltÃ¤en",                                 target:"inklusive",                                   article:null,  word:"inklusive" },
  { source:"backstagepassi",                            target:"der Backstage-Pass",                          article:"der", word:"Backstage-Pass" },
  { source:"siellÃ¤",                                    target:"dort",                                        article:null,  word:"dort" },
  { source:"bÃ¤ndi",                                     target:"die Band",                                    article:"die", word:"Band" },
  { source:"jotakin on jossakin",                       target:"es gibt",                                     article:null,  word:"es gibt" },
  { source:"valtava",                                   target:"gigantisch",                                  article:null,  word:"gigantisch" },
  { source:"ilotulitus",                                target:"das Feuerwerk",                               article:"das", word:"Feuerwerk" },
  { source:"parasta",                                   target:"das Beste",                                   article:"das", word:"Beste" },
  { source:"kesÃ¤llÃ¤",                                   target:"im Sommer",                                   article:null,  word:"im Sommer" },
  { source:"kesÃ¤",                                      target:"der Sommer",                                  article:"der", word:"Sommer" },
  { source:"tÃ¤nÃ¤ vuonna",                               target:"dieses Jahr",                                 article:null,  word:"dieses Jahr" },
  { source:"vuosi",                                     target:"das Jahr",                                    article:"das", word:"Jahr" },
  { source:"ulkona",                                    target:"im Freien",                                   article:null,  word:"im Freien" },
  { source:"toivottavasti",                             target:"hoffentlich",                                 article:null,  word:"hoffentlich" },
  { source:"sataa",                                     target:"regnen",                                      article:null,  word:"regnen" },
  { source:"kaverini olivat",                           target:"meine Kumpels waren",                         article:null,  word:"meine Kumpels waren" },
  { source:"kaveri",                                    target:"der Kumpel",                                  article:"der", word:"Kumpel" },
  { source:"viime vuonna",                              target:"letztes Jahr",                                article:null,  word:"letztes Jahr" },
  { source:"heinÃ¤kuussa",                               target:"im Juli",                                     article:null,  word:"im Juli" },
  { source:"heinÃ¤kuu",                                  target:"der Juli",                                    article:"der", word:"Juli" },
  { source:"valitettavasti",                            target:"leider",                                      article:null,  word:"leider" },
  { source:"sÃ¤Ã¤",                                       target:"das Wetter",                                  article:"das", word:"Wetter" },
  { source:"HeillÃ¤ oli hauskaa.",                       target:"Sie hatten SpaÃŸ.",                            article:null,  word:"Sie hatten SpaÃŸ." },
  { source:"olla hauskaa",                              target:"SpaÃŸ haben",                                  article:null,  word:"SpaÃŸ haben" },
  { source:"siitÃ¤ huolimatta",                          target:"trotzdem",                                    article:null,  word:"trotzdem" },
  { source:"joskus, kerran",                            target:"mal",                                         article:null,  word:"mal" },
  { source:"sinne",                                     target:"dahin",                                       article:null,  word:"dahin" },
  { source:"jo; tÃ¤ssÃ¤: joo, toki, miksipÃ¤ ei",         target:"schon",                                       article:null,  word:"schon" },
  { source:"kahdelle henkilÃ¶lle",                       target:"fÃ¼r zwei Personen",                           article:null,  word:"fÃ¼r zwei Personen" },
  { source:"henkilÃ¶",                                   target:"die Person",                                  article:"die", word:"Person" },
  { source:"sinut; sinua",                              target:"dich",                                        article:null,  word:"dich" },
  { source:"ottaa mukaan",                              target:"mitnehmen",                                   article:null,  word:"mitnehmen" },
  { source:"Oletko tosissasi?",                         target:"Ist das dein Ernst?",                         article:null,  word:"Ist das dein Ernst?" },
  { source:"paras (tyttÃ¶)ystÃ¤vÃ¤",                       target:"die beste Freundin",                          article:"die", word:"beste Freundin" },
  { source:"maailmassa",                                target:"auf der Welt",                                article:null,  word:"auf der Welt" },
  { source:"maailma",                                   target:"die Welt",                                    article:"die", word:"Welt" },
  { source:"ilman sinua",                               target:"ohne dich",                                   article:null,  word:"ohne dich" },
  { source:"Se ei ole ollenkaan hauskaa!",              target:"Das macht keinen SpaÃŸ!",                      article:null,  word:"Das macht keinen SpaÃŸ!" },
  { source:"jokin on hauskaa",                          target:"SpaÃŸ machen",                                 article:null,  word:"SpaÃŸ machen" },
  { source:"tapaamme (toisemme)",                       target:"wir treffen uns",                             article:null,  word:"wir treffen uns" },
  { source:"tavata",                                    target:"treffen",                                     article:null,  word:"treffen" },
  { source:"suunnitella",                               target:"planen",                                      article:null,  word:"planen" },
  { source:"Se sopii.",                                 target:"Das geht.",                                   article:null,  word:"Das geht." },
  { source:"no sitten",                                 target:"also dann",                                   article:null,  word:"also dann" },
  { source:"Huomiseen!",                                target:"Bis morgen!",                                 article:null,  word:"Bis morgen!" },
  { source:"NÃ¤hdÃ¤Ã¤n pian!",                             target:"Bis bald!",                                   article:null,  word:"Bis bald!" },
];

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GRADIENT THEMES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const GRADS = [
  { name:"Kosminen",     bg:"linear-gradient(135deg,#1a1a2e,#16213e,#0f3460,#533483)", sw:"linear-gradient(135deg,#533483,#0f3460)" },
  { name:"Merivirta",    bg:"linear-gradient(135deg,#0d2137,#0a4a6e,#0a7a6b)",         sw:"linear-gradient(135deg,#0a7a6b,#0a4a6e)" },
  { name:"Auringonlasku",bg:"linear-gradient(135deg,#2d0a1e,#7b1a4b,#c0392b)",         sw:"linear-gradient(135deg,#c0392b,#7b1a4b)" },
  { name:"MetsÃ¤",        bg:"linear-gradient(135deg,#0d1b2a,#1b4332,#2d6a4f)",         sw:"linear-gradient(135deg,#2d6a4f,#1b4332)" },
  { name:"Kristalli",    bg:"linear-gradient(135deg,#1a0533,#4a0080,#9b00d3)",          sw:"linear-gradient(135deg,#9b00d3,#4a0080)" },
];

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const S = {
  mode: 'write',      // 'write' | 'multiple' | 'flash' | 'build'
  reversed: false,
  gradIdx: 0,
  words: [],          // current game words (shuffled)
  wrong: [],          // words answered incorrectly
  idx: 0,             // current word index
  score: 0,
  done: false,        // current question answered?
  // flash-specific
  flipped: false,
  // build-specific
  buildTarget: '',    // word to build (original case, no article)
  buildTiles: [],     // [{char, id, used}]
  buildPlaced: [],    // tile ids in placement order
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DOM
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const el = id => document.getElementById(id);

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HELPERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function shuffle(a) { return [...a].sort(() => Math.random() - 0.5); }
function norm(s)    { return s ? s.toLowerCase().replace(/\s+/g,' ').trim() : ''; }

function question(w) { return S.reversed ? w.target  : w.source; }
function answer(w)   { return S.reversed ? w.source  : w.target; }
function answerCore(w){ return S.reversed ? w.source  : w.word;  }
function articleOf(w){ return S.reversed ? null : w.article; }

function langHint() {
  const { sourceLanguage:sl, targetLanguage:tl, sourceFlagEmoji:sf, targetFlagEmoji:tf } = LANG;
  return S.reversed ? `${tf} ${tl} â†’ ${sl} ${sf}` : `${sf} ${sl} â†’ ${tl} ${tf}`;
}

/* isBuildable: only plain words (letters only, 3â€“18 chars) */
function isBuildable(w) {
  const word = S.reversed ? w.source : w.word;
  return /^[\wÃ¤Ã¶Ã¼Ã„Ã–ÃœÃŸÃ Ã¢Ã©Ã¨ÃªÃ«Ã®Ã¯Ã´Ã¹Ã»Å“Ã¦Ã…Ã¥Ã¸Ã˜]+$/u.test(word) && word.length >= 3 && word.length <= 18;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCREEN MANAGEMENT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showScreen(name) {
  ['startScreen','gameScreen','flashScreen','buildScreen','resultsScreen'].forEach(id => {
    el(id).classList.remove('active');
  });
  el(name + 'Screen').classList.add('active');

  const inGame = ['game','flash','build'].includes(name);
  el('bottomNav').classList.toggle('hidden', inGame);
  el('dirSection').classList.toggle('hidden', inGame);
  el('btnQuit').classList.toggle('vis', inGame);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SETTINGS â€” GRADIENTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
GRADS.forEach((g, i) => {
  const sw = document.createElement('div');
  sw.className = 'swatch' + (i === 0 ? ' active' : '');
  sw.style.background = g.sw; sw.title = g.name;
  sw.setAttribute('role','button'); sw.setAttribute('tabindex','0');
  sw.addEventListener('click', () => setGrad(i));
  sw.addEventListener('keydown', e => { if (e.key==='Enter'||e.key===' ') setGrad(i); });
  el('swatchWrap').appendChild(sw);
});
function setGrad(i) {
  S.gradIdx = i;
  document.body.style.background = GRADS[i].bg;
  document.body.style.backgroundAttachment = 'fixed';
  el('swatchWrap').querySelectorAll('.swatch').forEach((s,j) => s.classList.toggle('active', j===i));
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SETTINGS â€” OPEN / CLOSE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openSettings()  {
  el('settingsPanel').classList.add('open');
  el('settingsBtn').classList.add('open');
  el('settingsBtn').setAttribute('aria-expanded','true');
  el('overlay').classList.add('open');
}
function closeSettings() {
  el('settingsPanel').classList.remove('open');
  el('settingsBtn').classList.remove('open');
  el('settingsBtn').setAttribute('aria-expanded','false');
  el('overlay').classList.remove('open');
}
el('settingsBtn').addEventListener('click', e => {
  e.stopPropagation();
  el('settingsPanel').classList.contains('open') ? closeSettings() : openSettings();
});
el('overlay').addEventListener('click', closeSettings);

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SETTINGS â€” DIRECTION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function updateDirUI() {
  const { sourceLanguage:sl, targetLanguage:tl, sourceFlagEmoji:sf, targetFlagEmoji:tf } = LANG;
  if (S.reversed) {
    el('drFlags').textContent = `${tf} â†’ ${sf}`;
    el('drText').textContent  = `${tl} â†’ ${sl}`;
    el('dirRow').classList.add('reversed');
  } else {
    el('drFlags').textContent = `${sf} â†’ ${tf}`;
    el('drText').textContent  = `${sl} â†’ ${tl}`;
    el('dirRow').classList.remove('reversed');
  }
}
function updateStartUI() {
  const { sourceLanguage:sl, targetLanguage:tl, sourceFlagEmoji:sf, targetFlagEmoji:tf } = LANG;
  if (S.reversed) {
    el('startH1').textContent = `${tl}â€“${sl} Sanastopeli`;
    el('langPill').innerHTML  = `${tf} ${tl} &nbsp;â†’&nbsp; ${sl} ${sf}`;
  } else {
    el('startH1').textContent = `${sl}â€“${tl} Sanastopeli`;
    el('langPill').innerHTML  = `${sf} ${sl} &nbsp;â†’&nbsp; ${tl} ${tf}`;
  }
  const modeLabels = { write:'kirjoittamalla', multiple:'monivalinnalla', flash:'kÃ¤Ã¤ntÃ¶korteilla', build:'rakentamalla' };
  const art = (S.mode !== 'build' && !S.reversed) ? '<br>Saat pisteen, vaikka artikkeli unohtuisi!' : '';
  el('startDesc').innerHTML = `Harjoittele sanastoa ${modeLabels[S.mode]}.${art}`;
}
el('dirRow').addEventListener('click', () => { S.reversed = !S.reversed; updateDirUI(); updateStartUI(); });
el('dirRow').addEventListener('keydown', e => { if (e.key==='Enter'||e.key===' ') { e.preventDefault(); el('dirRow').click(); } });

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOTTOM NAV
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
['nbFlash','nbBuild','nbMultiple','nbWrite'].forEach(id => {
  el(id).addEventListener('click', () => {
    S.mode = el(id).dataset.mode;
    ['nbFlash','nbBuild','nbMultiple','nbWrite'].forEach(x => el(x).classList.remove('active'));
    el(id).classList.add('active');
    updateStartUI();
  });
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GAME â€” START
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function startGame(wordsOverride) {
  let pool = wordsOverride ? [...wordsOverride] : [...VOCAB];
  if (S.mode === 'build') {
    pool = pool.filter(isBuildable);
    if (pool.length === 0) pool = [...VOCAB].filter(isBuildable); // fallback
  }
  S.words = shuffle(pool);
  S.wrong = []; S.idx = 0; S.score = 0; S.done = false;
  closeSettings();
  const screenMap = { write:'game', multiple:'game', flash:'flash', build:'build' };
  showScreen(screenMap[S.mode]);
  const renderMap = { write: renderWord, multiple: renderWord, flash: renderFlash, build: renderBuild };
  renderMap[S.mode]();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESULTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showResults() {
  showScreen('results');
  const total = S.words.length;
  const pct   = Math.round((S.score / total) * 100);
  el('resScore').textContent = `${S.score} / ${total}`;
  el('resPct').textContent   = `${pct}%`;
  if      (pct===100) { el('resEmoji').textContent='ğŸ†'; el('resMsg').textContent='TÃ¤ydellinen suoritus!'; }
  else if (pct>= 80)  { el('resEmoji').textContent='ğŸ’ª'; el('resMsg').textContent='Erinomaista tyÃ¶tÃ¤!'; }
  else if (pct>= 50)  { el('resEmoji').textContent='ğŸ‘'; el('resMsg').textContent='HyvÃ¤ alku, jatka harjoittelua!'; }
  else                { el('resEmoji').textContent='ğŸ“š'; el('resMsg').textContent='Harjoitus tekee mestarin!'; }
  if (S.wrong.length > 0) {
    el('btnWrong').classList.remove('hidden');
    el('btnWrong').textContent = `Harjoittele vÃ¤Ã¤rÃ¤t uudelleen (${S.wrong.length}) ğŸ”`;
  } else {
    el('btnWrong').classList.add('hidden');
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SHARED FEEDBACK HELPER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showFb(fbId, type, html) {
  const f = el(fbId);
  f.className = `fb show ${type}`;
  f.innerHTML = html;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   WRITE & MULTIPLE CHOICE MODE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderWord() {
  const w = S.words[S.idx];
  S.done = false;
  el('progTxt').textContent  = `Sana ${S.idx+1} / ${S.words.length}`;
  el('scoreTxt').textContent = `Pisteet: ${S.score}`;
  el('progFill').style.width = `${(S.idx/S.words.length)*100}%`;
  el('dirHint').textContent  = langHint();
  el('wordTxt').textContent  = question(w);
  el('fb').className = 'fb'; el('fb').innerHTML = '';
  el('btnNext').classList.remove('vis');

  if (S.mode === 'write') {
    el('writeWrap').classList.remove('hidden');
    el('choiceWrap').classList.add('hidden');
    el('btnCheck').style.display = '';
    el('answerInput').value = ''; el('answerInput').disabled = false;
    setTimeout(() => el('answerInput').focus(), 80);
  } else {
    el('writeWrap').classList.add('hidden');
    el('choiceWrap').classList.remove('hidden');
    el('btnCheck').style.display = 'none';
    buildChoices(w);
  }
}

function checkWrite() {
  if (S.done) { advanceWord(); return; }
  const w = S.words[S.idx];
  const user = norm(el('answerInput').value);
  if (!user) return;
  const full = norm(answer(w));
  const core = norm(answerCore(w));
  const art  = articleOf(w);
  let status;
  if      (user === full)                              status = 'perfect';
  else if (art && (user===core || user===norm(w.word))) status = 'partial';
  else                                                 status = 'wrong';
  el('answerInput').disabled = true;
  el('btnCheck').style.display = 'none';
  S.done = true;
  if (status==='perfect') { S.score++; showFb('fb','ok',  `âœ… <strong>TÃ¤ysin oikein!</strong><br><em>${answer(w)}</em>`); }
  else if (status==='partial') { S.score++; showFb('fb','warn',`âš ï¸ <strong>Oikein â€“ muista artikkeli!</strong><br>Oikea muoto: <em>${answer(w)}</em>`); }
  else { S.wrong.push(w); showFb('fb','err', `âŒ <strong>VÃ¤Ã¤rin.</strong> Oikea vastaus: <em>${answer(w)}</em>`); }
  el('scoreTxt').textContent = `Pisteet: ${S.score}`;
  el('btnNext').classList.add('vis'); el('btnNext').focus();
}

function buildChoices(correct) {
  const pool = VOCAB.filter(w => answer(w) !== answer(correct));
  const opts = shuffle([correct, ...shuffle(pool).slice(0,3)]);
  el('choicesGrid').innerHTML = '';
  opts.forEach(opt => {
    const btn = document.createElement('button');
    btn.className = 'choice'; btn.textContent = answer(opt);
    btn.addEventListener('click', () => pickChoice(btn, opt, correct));
    el('choicesGrid').appendChild(btn);
  });
}
function pickChoice(clicked, chosen, correct) {
  if (S.done) return;
  S.done = true;
  const isOk = answer(chosen) === answer(correct);
  el('choicesGrid').querySelectorAll('.choice').forEach(b => {
    b.disabled = true;
    if (norm(b.textContent) === norm(answer(correct))) b.classList.add('correct');
    else if (b===clicked && !isOk)                    b.classList.add('wrong');
    else                                               b.classList.add('dim');
  });
  if (isOk) { S.score++; showFb('fb','ok', `âœ… Oikein! <em>${answer(correct)}</em>`); }
  else      { S.wrong.push(correct); showFb('fb','err',`âŒ VÃ¤Ã¤rin! Oikea: <em>${answer(correct)}</em>`); }
  el('scoreTxt').textContent = `Pisteet: ${S.score}`;
  el('btnNext').classList.add('vis'); el('btnNext').focus();
}

function advanceWord() {
  S.idx++;
  if (S.idx >= S.words.length) showResults(); else renderWord();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FLASHCARD MODE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderFlash() {
  const w = S.words[S.idx];
  S.done = false; S.flipped = false;
  el('fProgTxt').textContent  = `Kortti ${S.idx+1} / ${S.words.length}`;
  el('fScoreTxt').textContent = `Pisteet: ${S.score}`;
  el('fProgFill').style.width = `${(S.idx/S.words.length)*100}%`;
  el('fDirHint').textContent  = langHint();

  const { sourceLanguage:sl, targetLanguage:tl } = LANG;
  el('cardFrontLabel').textContent = S.reversed ? tl : sl;
  el('cardBackLabel').textContent  = S.reversed ? sl : tl;
  el('cardFront').textContent = question(w);
  el('cardBack').textContent  = answer(w);

  el('card3d').classList.remove('flipped');
  el('cardActions').classList.remove('vis');
  el('cardKeyHints').classList.remove('vis');
  el('cardTapHint').style.opacity = '1';
  el('cardTapHint').textContent = 'Napauta korttia kÃ¤Ã¤ntÃ¤Ã¤ksesi â†•';
  el('cardScene').focus();
}

function flipCard() {
  if (S.done) return;
  S.flipped = !S.flipped;
  el('card3d').classList.toggle('flipped', S.flipped);
  if (S.flipped) {
    el('cardTapHint').style.opacity = '0';
    el('cardActions').classList.add('vis');
    el('cardKeyHints').classList.add('vis');
  } else {
    el('cardTapHint').style.opacity = '1';
    el('cardActions').classList.remove('vis');
    el('cardKeyHints').classList.remove('vis');
  }
}

function markCard(correct) {
  if (!S.flipped || S.done) return;
  S.done = true;
  if (correct) S.score++;
  else         S.wrong.push(S.words[S.idx]);
  el('fScoreTxt').textContent = `Pisteet: ${S.score}`;
  el('cardActions').classList.remove('vis');
  el('cardKeyHints').classList.remove('vis');
  el('cardTapHint').style.opacity = '1';
  el('cardTapHint').textContent = correct ? 'âœ… Merkitty oikein' : 'âŒ Merkitty vÃ¤Ã¤rin';
  // Advance after short pause so user sees the result
  setTimeout(advanceFlash, 700);
}

function advanceFlash() {
  S.idx++;
  if (S.idx >= S.words.length) showResults(); else renderFlash();
}

el('cardScene').addEventListener('click', flipCard);
el('cardScene').addEventListener('keydown', e => {
  if (e.key === ' '          ) { e.preventDefault(); flipCard(); }
});
el('btnCardRight').addEventListener('click', e => { e.stopPropagation(); markCard(true);  });
el('btnCardWrong').addEventListener('click', e => { e.stopPropagation(); markCard(false); });

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   WORD BUILDER MODE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderBuild() {
  const w = S.words[S.idx];
  S.done = false;
  S.buildTarget = S.reversed ? w.source : w.word;
  S.buildTiles  = shuffle(S.buildTarget.split('').map((char,i) => ({ char, id:i, used:false })));
  S.buildPlaced = [];

  el('bProgTxt').textContent  = `Sana ${S.idx+1} / ${S.words.length}`;
  el('bScoreTxt').textContent = `Pisteet: ${S.score}`;
  el('bProgFill').style.width = `${(S.idx/S.words.length)*100}%`;
  el('bDirHint').textContent  = langHint();
  el('buildQuestion').textContent = question(w);

  // Article badge
  const art = articleOf(w);
  const artEl = el('buildArticle');
  if (art && !S.reversed) {
    artEl.textContent = art; artEl.style.display = '';
  } else {
    artEl.style.display = 'none';
  }

  el('buildLenHint').textContent = `${S.buildTarget.length} kirjainta`;
  el('bFb').className = 'fb'; el('bFb').innerHTML = '';
  el('btnBuildCheck').style.display = '';
  el('btnBuildNext').classList.remove('vis');
  el('btnBuildClear').disabled = false;

  renderBuildSlots();
  renderBuildTiles();
}

function renderBuildSlots() {
  const slotsEl = el('buildSlots');
  slotsEl.innerHTML = '';
  for (let i = 0; i < S.buildTarget.length; i++) {
    const slot = document.createElement('div');
    if (i < S.buildPlaced.length) {
      const tile = S.buildTiles.find(t => t.id === S.buildPlaced[i]);
      slot.className = 'build-slot filled';
      slot.textContent = tile.char;
      const idx = i;
      slot.addEventListener('click', () => { if (!S.done) removePlaced(idx); });
    } else {
      slot.className = 'build-slot empty';
    }
    slotsEl.appendChild(slot);
  }
}

function renderBuildTiles() {
  const tilesEl = el('buildTiles');
  tilesEl.innerHTML = '';
  S.buildTiles.forEach((tile, i) => {
    const t = document.createElement('div');
    t.className = 'build-tile' + (tile.used ? ' used' : '');
    t.textContent = tile.char;
    if (!tile.used) {
      t.addEventListener('click', () => { if (!S.done) placeTile(i); });
    }
    tilesEl.appendChild(t);
  });
}

function placeTile(i) {
  if (S.buildPlaced.length >= S.buildTarget.length) return;
  S.buildTiles[i].used = true;
  S.buildPlaced.push(S.buildTiles[i].id);
  renderBuildSlots();
  renderBuildTiles();
}

function removePlaced(slotIdx) {
  const tileId = S.buildPlaced[slotIdx];
  const tile = S.buildTiles.find(t => t.id === tileId);
  if (tile) tile.used = false;
  S.buildPlaced.splice(slotIdx, 1);
  renderBuildSlots();
  renderBuildTiles();
}

function clearBuild() {
  S.buildTiles.forEach(t => t.used = false);
  S.buildPlaced = [];
  renderBuildSlots();
  renderBuildTiles();
}

function checkBuild() {
  if (S.done) { advanceBuild(); return; }
  if (S.buildPlaced.length < S.buildTarget.length) {
    showFb('bFb','warn','âš ï¸ LisÃ¤Ã¤ vielÃ¤ kirjaimia!');
    return;
  }
  const userWord = S.buildTiles
    .filter(t => S.buildPlaced.includes(t.id))
    .sort((a,b) => S.buildPlaced.indexOf(a.id) - S.buildPlaced.indexOf(b.id))
    .map(t => t.char).join('');

  const correct = norm(userWord) === norm(S.buildTarget);
  S.done = true;
  el('btnBuildCheck').style.display = 'none';
  el('btnBuildClear').disabled = true;

  // Colour the slots
  el('buildSlots').querySelectorAll('.build-slot.filled').forEach((slot, i) => {
    slot.classList.remove('filled');
    slot.classList.add(correct ? 'correct-slot' : 'wrong-slot');
  });

  const w = S.words[S.idx];
  if (correct) {
    S.score++;
    showFb('bFb','ok', `âœ… <strong>Oikein!</strong> ${articleOf(w) ? articleOf(w)+' ' : ''}${S.buildTarget}`);
  } else {
    S.wrong.push(w);
    showFb('bFb','err', `âŒ <strong>VÃ¤Ã¤rin.</strong> Oikea: <em>${answer(w)}</em>`);
  }
  el('bScoreTxt').textContent = `Pisteet: ${S.score}`;
  el('btnBuildNext').classList.add('vis'); el('btnBuildNext').focus();
}

function advanceBuild() {
  S.idx++;
  if (S.idx >= S.words.length) showResults(); else renderBuild();
}

el('btnBuildClear').addEventListener('click', clearBuild);
el('btnBuildCheck').addEventListener('click', checkBuild);
el('btnBuildNext').addEventListener('click',  advanceBuild);

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GLOBAL KEYBOARD (flashcard arrows, enter)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.addEventListener('keydown', e => {
  // Flashcard keyboard shortcuts
  if (S.mode==='flash' && el('flashScreen').classList.contains('active')) {
    if (e.key==='ArrowUp'||e.key==='ArrowDown') { e.preventDefault(); flipCard(); return; }
    if (e.key==='ArrowRight') { e.preventDefault(); markCard(true);  return; }
    if (e.key==='ArrowLeft')  { e.preventDefault(); markCard(false); return; }
  }
  // Enter in write mode
  if (S.mode==='write' && el('gameScreen').classList.contains('active')) {
    if (e.key==='Enter') {
      e.preventDefault();
      if (!S.done) checkWrite(); else advanceWord();
    }
  }
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESULTS BUTTONS & SHARED EVENTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
el('btnGo').addEventListener('click',      () => startGame());
el('btnCheck').addEventListener('click',   checkWrite);
el('btnNext').addEventListener('click',    advanceWord);
el('btnRestart').addEventListener('click', () => startGame());
el('btnWrong').addEventListener('click',   () => startGame([...S.wrong]));
el('btnQuit').addEventListener('click',    () => { closeSettings(); showScreen('start'); updateStartUI(); });

el('answerInput').addEventListener('keydown', e => {
  if (e.key !== 'Enter') return;
  e.preventDefault();
  if (!S.done) checkWrite(); else advanceWord();
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   iOS HINT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
if (/iphone|ipad|ipod/i.test(navigator.userAgent) && !navigator.standalone) {
  el('iosHint').style.display = 'block';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
updateDirUI();
updateStartUI();
</script>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOADER LOGIC
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

const loader = document.getElementById("appLoader");
const loaderBar = document.getElementById("loaderBarFill");

let progress = 0;

const fakeLoad = setInterval(() => {
  progress += Math.random() * 20;
  if (progress > 90) progress = 90;
  loaderBar.style.width = progress + "%";
}, 180);

window.addEventListener("load", () => {
  clearInterval(fakeLoad);
  loaderBar.style.width = "100%";

  setTimeout(() => {
    loader.classList.add("hide");
  }, 400);
});
</script>

</body>
</html>
